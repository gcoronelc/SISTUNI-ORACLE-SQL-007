-- CASO: SISTEMA DE VENTAS ELEMENTAL

-- =========================================
-- 01: CREAR EL TABLESPACE
-- =========================================

-- Crear el Tablespace
CREATE TABLESPACE TBS_VENTAS
DATAFILE 'O:\APP\TBS\DF_VENTAS.DBF'
SIZE 10M;

CREATE TABLESPACE TBS_VENTAS2
DATAFILE 'O:\APP\TBS\DF_VENTAS2.DBF'
SIZE 10M;


-- Espacio Total en MB
SELECT 
	tablespace_name,
	round(sum(BYTES/1024/1024),0) ESPACIO_MB
FROM dba_data_files b
WHERE tablespace_name LIKE 'TBS_VEN%'
GROUP BY b.tablespace_name
ORDER BY 1;

-- Espacio libre en MB
SELECT 
	tablespace_name,
	ROUND(sum(BYTES/1024/1024),0)  ESPACIO_MB
FROM dba_free_space
WHERE tablespace_name LIKE 'TBS_VEN%'
GROUP BY tablespace_name
ORDER BY 1;



-- =========================================
-- 02: CREACION DEL USUARIO
-- =========================================

CREATE USER VENTASAPP IDENTIFIED BY admin;

SELECT USERNAME FROM DBA_USERS
WHERE USERNAME LIKE 'VENTAS%';



-- =========================================
-- 03: ASIGNAR TABLESPACE AL USUARIO
-- =========================================

ALTER USER VENTASAPP 
	DEFAULT TABLESPACE TBS_VENTAS 
	QUOTA UNLIMITED ON TBS_VENTAS;
	
ALTER USER VENTASAPP 
  QUOTA 5M ON TBS_VENTAS2;	
	
SELECT USERNAME, DEFAULT_TABLESPACE 
FROM DBA_USERS
WHERE USERNAME LIKE 'VENTAS%';

SELECT * FROM DBA_TS_QUOTAS
WHERE USERNAME LIKE 'VENTAS%';


-- =========================================
-- 04: ASIGNAR PRIVILEGIOS
-- =========================================

GRANT CREATE SESSION TO VENTASAPP;

GRANT CREATE TABLE TO VENTASAPP;



-- =========================================
-- 05: CREAR TABLAS
-- =========================================

CREATE TABLE VENTASAPP.PRODUCTO(
  PRO_ID NUMBER(8) NOT NULL,
  PRO_NOMBRE VARCHAR2(100) NOT NULL,
  PRO_PRECIO NUMBER(8,2) NOT NULL,
  PRO_STOCK NUMBER(5) NOT NULL,
  CONSTRAINT PK_PRODUCTO PRIMARY KEY(PRO_ID)
) TABLESPACE TBS_VENTAS2;


-- DROP TABLE VENTASAPP.VENTAS PURGE;

CREATE TABLE VENTASAPP.VENTAS(
  VEN_ID      NUMBER(8) NOT NULL,
  VEN_CLIENTE VARCHAR2(100) NOT NULL,
  VEN_FECHA   DATE DEFAULT SYSDATE NOT NULL,
  PRO_ID      NUMBER(8) NOT NULL,
  VEN_PRECIO  NUMBER(8,2) NOT NULL,
  VEN_CANT    NUMBER(8) NOT NULL,
  VEN_IMPORTE NUMBER(8,2) NOT NULL,
  CONSTRAINT PK_VENTA PRIMARY KEY(VEN_ID),
  CONSTRAINT FK_VENTA_PRODUCTO
    FOREIGN KEY(PRO_ID) REFERENCES VENTASAPP.PRODUCTO
);


Select owner, decode(partition_name, null, segment_name,
segment_name || ':' || partition_name) name,
segment_type, tablespace_name,bytes,initial_extent,
next_extent, PCT_INCREASE, extents, max_extents
from dba_segments
Where OWNER='VENTASAPP';



-- =========================================
-- 06: OTRAS RESTRICCIONES
-- =========================================

ALTER TABLE VENTASAPP.PRODUCTO
ADD CONSTRAINT CK_PRODUCTO_PRECIO
CHECK ( PRO_PRECIO > 0.0 );

INSERT INTO VENTASAPP.PRODUCTO(PRO_ID,PRO_NOMBRE,PRO_PRECIO,PRO_STOCK)
VALUES(1,'PRODUCTO 1',50.0,100);

INSERT INTO VENTASAPP.PRODUCTO(PRO_ID,PRO_NOMBRE,PRO_PRECIO,PRO_STOCK)
VALUES(2,'PRODUCTO 2',90.0,150);

ALTER TABLE VENTASAPP.PRODUCTO
ADD CONSTRAINT U_PRODUCTO_NOMBRE
UNIQUE ( PRO_NOMBRE );

INSERT INTO VENTASAPP.PRODUCTO(PRO_ID,PRO_NOMBRE,PRO_PRECIO,PRO_STOCK)
VALUES(3,'PRODUCTO 2',90.0,150);

ROLLBACK;

SELECT * FROM VENTASAPP.PRODUCTO;


ALTER TABLE VENTASAPP.VENTAS 
ADD CONSTRAINT CK_VENTAS_ROW
CHECK (VEN_IMPORTE = (VEN_PRECIO * VEN_CANT));


INSERT INTO VENTASAPP.VENTAS( VEN_ID, VEN_CLIENTE, VEN_FECHA,
PRO_ID, VEN_PRECIO, VEN_CANT, VEN_IMPORTE )
VALUES(1, 'GUSTAVO', SYSDATE, 1, 70.0, 8, 560.0 );

COMMIT;

SELECT * FROM VENTASAPP.VENTAS;










